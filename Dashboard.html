<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Dashboard - FlagHunt</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@300;400;500;700&family=Roboto:wght@300;400;500;700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="./style.css?v=2">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    /* Local Overrides for Dashboard Tables/Charts */
    .dashboard-grid {
      display: grid;
      gap: 20px;
      grid-template-columns: 1fr;
    }

    .table-container {
      background: var(--thm-bg-card);
      border: 1px solid var(--thm-border);
      border-radius: 8px;
      padding: 20px;
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    th,
    td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid var(--thm-border);
    }

    th {
      color: var(--thm-green);
      font-weight: 600;
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 0.5px;
    }

    td {
      color: var(--thm-text-muted);
    }

    tr:hover td {
      background: rgba(255, 255, 255, 0.02);
      color: white;
    }

    .search-input {
      background: #141d2b;
      border: 1px solid #2b3b55;
      color: white;
      padding: 8px 12px;
      border-radius: 4px;
      width: 100%;
      max-width: 300px;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--thm-green);
    }

    .stat-card {
      background: var(--thm-bg-card);
      border: 1px solid var(--thm-border);
      border-radius: 8px;
      padding: 20px;
    }

    .welcome-banner {
      background: linear-gradient(90deg, #1a2333 0%, #111b2b 100%);
      border: 1px solid var(--thm-border);
      padding: 30px;
      border-radius: 8px;
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
  </style>
</head>

<body>

  <!-- NAVBAR -->
  <header>
    <div style="display: flex; align-items: center;">
      <a href="CyberSecurity Awareness.html" class="nav-brand">
        <i class="fas fa-flag-checkered" style="color:white; font-size: 24px;"></i>
        FlagHunt
      </a>
      <div class="nav-links">
        <a href="Dashboard.html" class="nav-item active">
          <i class="fas fa-chart-line nav-icon"></i>
          Dashboard
        </a>
        <a href="Levels.html" class="nav-item">
          <i class="fas fa-book-open nav-icon"></i>
          Learn
        </a>
        <a href="Awareness.html" class="nav-item">
          <i class="fas fa-shield-alt nav-icon"></i>
          Awareness
        </a>
        <a href="Guides.html" class="nav-item">
          <i class="fas fa-file-alt nav-icon"></i>
          Guides
        </a>
      </div>
    </div>

    <div class="nav-right">
      <a href="#" class="premium-btn" onclick="logout()" style="background: #ff2e2e; color: white;">Disconnect</a>
      <div class="user-profile">
        <img src="https://ui-avatars.com/api/?name=User&background=0D8ABC&color=fff" alt="User">
      </div>
    </div>
  </header>

  <!-- MAIN CONTAINER -->
  <div class="container" style="padding-top: 80px;">

    <!-- WELCOME HEADER -->
    <div class="welcome-banner">
      <div>
        <h1 style="margin: 0; font-size: 24px;">Welcome back, <span id="welcomeUser"
            style="color: var(--thm-green);">Agent</span></h1>
        <p style="margin: 5px 0 0; color: var(--thm-text-muted);">Track your progress and analyze your performance.</p>
      </div>
      <div style="display: flex; gap: 10px;">
        <!-- Actions could go here -->
      </div>
    </div>

    <!-- CONTROLS -->
    <div
      style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
      <input id="searchInput" class="search-input" placeholder="Filter Intel Data..." oninput="renderTable()" />
      <div style="display: flex; gap: 10px;">
        <button class="btn-action primary" onclick="exportCSV()"><i class="fas fa-file-csv"></i> Export CSV</button>
        <button class="btn-action" onclick="clearAll()" style="border-color: #ff2e2e; color: #ff2e2e;"><i
            class="fas fa-trash"></i> Purge Data</button>
      </div>
    </div>

    <div class="dashboard-grid">
      <!-- CHART SECTION -->
      <div class="stat-card">
        <h3
          style="margin-top: 0; margin-bottom: 20px; color: var(--thm-text); font-size: 16px; text-transform: uppercase;">
          <i class="fas fa-chart-bar" style="color: var(--thm-green); margin-right: 8px;"></i> Performance Analytics
        </h3>
        <canvas id="scoreChart" height="80"></canvas>
      </div>

      <!-- TABLE SECTION -->
      <div class="table-container">
        <table id="resultsTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Module</th>
              <th>ID</th>
              <th>Alias</th>
              <th>Email</th>
              <th>Location</th>
              <th>Org</th>
              <th>Score</th>
              <th>Timestamp</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="resultsBody"></tbody>
        </table>
        <div id="noData" style="display:none; text-align:center; padding: 40px; color: var(--thm-text-muted);">
          <i class="fas fa-inbox" style="font-size: 32px; margin-bottom: 15px; opacity: 0.5;"></i><br>
          No data found in the current session.
        </div>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Dashboard Logic (Preserved) -->
  <script>
    let chartInstance = null;

    /* Normalize an entry to the fields we need */
    function parseEntry(entry, keyHint) {
      return {
        id: entry.id || entry.ID || entry.verificationId || entry.verifId || entry.verificationID || (entry.name ? ('R' + Math.floor(100000 + Math.random() * 900000)) : ''),
        name: entry.name || entry.studentName || entry.fullName || entry.username || entry.user || 'Unknown',
        email: entry.email || entry.eMail || entry.userEmail || entry.mail || '',
        city: entry.city || entry.location || entry.town || '',
        institute: entry.institute || entry.institution || entry.school || entry.college || '',
        quiz: entry.quiz || entry.quizName || entry.type || keyHint || 'Unknown',
        score: (typeof entry.score === 'number') ? entry.score
          : (typeof entry.score === 'string' && entry.score.match(/^\d+%?$/) ? parseInt(entry.score, 10) : (entry.percent || entry.scoreValue || 0)),
        date: entry.date || entry.takenAt || entry.timestamp || entry.submittedAt || new Date().toISOString()
      };
    }

    /* Scan localStorage and return normalized rows */
    function getAllQuizResultsAuto() {
      const all = [];

      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);

        if (!key || (!/quiz/i.test(key) && !/result/i.test(key) && !/results/i.test(key))) continue;

        let raw = localStorage.getItem(key);
        if (!raw) continue;

        try {
          const parsed = JSON.parse(raw);

          if (Array.isArray(parsed)) {
            parsed.forEach(item => {
              if (item && typeof item === 'object') all.push(parseEntry(item, key));
            });
          } else if (parsed && typeof parsed === 'object') {
            all.push(parseEntry(parsed, key));
          }
        } catch (err) {
          // ignore non-json entries
        }
      }

      all.sort((a, b) => {
        const da = Date.parse(a.date) || 0;
        const db = Date.parse(b.date) || 0;
        return db - da;
      });

      return all;
    }

    /* Render table and call chart update */
    function renderAutoDashboard() {
      const tbody = document.getElementById('resultsBody');
      const noData = document.getElementById('noData');
      if (!tbody) {
        console.error('resultsBody element not found.');
        return;
      }
      tbody.innerHTML = '';

      const q = document.getElementById("searchInput").value.toLowerCase().trim();
      const rows = getAllQuizResultsAuto().filter(r => {
        if (!q) return true;
        return (r.name || '').toLowerCase().includes(q) ||
          (r.email || '').toLowerCase().includes(q) ||
          (r.id || '').toLowerCase().includes(q) ||
          (r.quiz || '').toLowerCase().includes(q);
      });

      if (!rows.length) noData.style.display = 'block';
      else noData.style.display = 'none';

      rows.forEach((r, idx) => {
        const tr = document.createElement('tr');

        let displayDate = r.date;
        try { displayDate = new Date(r.date).toLocaleString(); } catch (e) { }

        let scoreText = (r.score === 0 || r.score) ? (Number(r.score) + '%') : '0%';

        tr.innerHTML = `
      <td>${idx + 1}</td>
      <td>${escapeHtml(String(r.quiz || 'Unknown'))}</td>
      <td>${escapeHtml(String(r.id || ''))}</td>
      <td>${escapeHtml(String(r.name || 'Unknown'))}</td>
      <td>${escapeHtml(String(r.email || ''))}</td>
      <td>${escapeHtml(String(r.city || ''))}</td>
      <td>${escapeHtml(String(r.institute || ''))}</td>
      <td>${escapeHtml(scoreText)}</td>
      <td>${escapeHtml(displayDate)}</td>
      <td><button style="padding:4px 8px;border-radius:4px;border:none;background:#ff2e2e;color:#fff;cursor:pointer;font-size:12px;" onclick="removeEntryFromLocal(${idx})"><i class="fas fa-times"></i></button></td>
    `;
        tbody.appendChild(tr);
      });

      updateChart(rows);
    }

    function escapeHtml(s) {
      if (s === null || s === undefined) return '';
      return String(s).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;');
    }

    function removeEntryFromLocal(indexInRender) {
      const flattened = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (!key || (!/quiz/i.test(key) && !/result/i.test(key) && !/results/i.test(key))) continue;
        try {
          const arr = JSON.parse(localStorage.getItem(key));
          if (Array.isArray(arr)) {
            arr.forEach((entry, pos) => {
              flattened.push({ key, pos, entry, normalized: parseEntry(entry, key) });
            });
          }
        } catch (e) { }
      }

      flattened.sort((a, b) => {
        const da = Date.parse(a.normalized.date) || 0;
        const db = Date.parse(b.normalized.date) || 0;
        return db - da;
      });

      const target = flattened[indexInRender];
      if (!target) { alert('Could not find entry to delete.'); return; }

      try {
        const arr = JSON.parse(localStorage.getItem(target.key));
        if (!Array.isArray(arr)) throw new Error('source not array');
        arr.splice(target.pos, 1);
        localStorage.setItem(target.key, JSON.stringify(arr));
        renderAutoDashboard();
      } catch (e) {
        console.error('Delete failed', e);
        alert('Failed to delete entry (see console).');
      }
    }

    function updateChart(rows) {
      const latest = rows.slice(0, 50).slice().reverse();
      const labels = latest.map(x => {
        try { return new Date(x.date).toLocaleDateString(); } catch (e) { return x.date || ''; }
      });
      const scores = latest.map(x => Number(x.score) || 0);

      const ctx = document.getElementById('scoreChart').getContext('2d');
      if (chartInstance) chartInstance.destroy();

      // Updated Chart Colors for Dark Theme
      Chart.defaults.color = '#aeb2b9';
      Chart.defaults.borderColor = '#2b3b55';

      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Score %',
            data: scores,
            backgroundColor: scores.map(s => s >= 60 ? 'rgba(136, 204, 20, 0.7)' : 'rgba(255, 46, 46, 0.7)'), // THM Green / Red
            borderColor: scores.map(s => s >= 60 ? '#88cc14' : '#ff2e2e'),
            borderWidth: 1,
            borderRadius: 4
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              grid: { color: '#2b3b55' }
            },
            x: {
              grid: { display: false }
            }
          }
        }
      });
    }

    function exportCSV() {
      const rows = getAllQuizResultsAuto();
      if (!rows.length) { alert('No data to export.'); return; }
      const header = ['quiz', 'id', 'name', 'email', 'city', 'institute', 'score', 'date'];
      const dataRows = rows.map(r => header.map(h => JSON.stringify(r[h] || '')).join(','));
      const csv = [header.join(','), ...dataRows].join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'quiz_results.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    function clearAll() {
      if (!confirm('Clear ALL quizzes data?')) return;
      const keysToRemove = [];
      for (let i = 0; i < localStorage.length; i++) {
        const k = localStorage.key(i);
        if (!k) continue;
        if (/quiz/i.test(k) || /result/i.test(k) || /results/i.test(k)) keysToRemove.push(k);
      }
      keysToRemove.forEach(k => localStorage.removeItem(k));
      renderAutoDashboard();
    }

    function goHome() {
      window.location.href = 'CyberSecurity Awareness.html';
    }

    function renderTable() {
      renderAutoDashboard();
    }

    window.addEventListener('load', function () {
      try { renderAutoDashboard(); }
      catch (e) { console.error('renderAutoDashboard error', e); }
    });
  </script>

  <!-- Login protection and logout function -->
  <script>
    document.getElementById('welcomeUser').textContent = 'Agent';

    function logout() {
      if (confirm('Are you sure you want to disconnect?')) {
        localStorage.removeItem('token');
        window.location.href = 'CyberSecurity Awareness.html';
      }
    }
  </script>

</body>

</html>