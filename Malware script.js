// CTF Data and Game State
const ctfData = {
    flags: {
        1: {
            id: 1,
            name: "File Inspection",
            description: "Identify the malware file type and architecture",
            clues: [
                {
                    command: "file malware.exe",
                    output: `malware.exe: PE32 executable (GUI) Intel 80386, for MS Windows
Characteristics: Executable, 32-bit, Windows`,
                    analysis: "The file is a 32-bit Windows PE executable with GUI subsystem."
                },
                {
                    command: "exiftool malware.exe",
                    output: `File Type                       : Win32 EXE
MIME Type                       : application/octet-stream
Machine Type                    : Intel 386 or later, and compatibles
Time Stamp                      : 2023:11:15 03:47:22+00:00
Entry Point                     : 0x401000`,
                    analysis: "Entry point at 0x401000, compiled timestamp matches incident time."
                }
            ],
            flag: "FLAG{PE32_WINDOWS_EXE}",
            hint: "Use the 'file' command to determine the file type and architecture. Look for 'PE32' in the output.",
            tools: ["file", "exiftool", "PEiD", "PEview"],
            points: 50,
            analyzed: false,
            captured: false
        },
        2: {
            id: 2,
            name: "Strings Analysis",
            description: "Extract readable strings and identify C2 server",
            clues: [
                {
                    command: "strings malware.exe | head -20",
                    output: `!This program cannot be run in DOS mode.
.text
.data
.rdata
@.data
GetModuleHandleA
GetProcAddress
LoadLibraryA
ws2_32.dll
socket
connect`,
                    analysis: "Basic Windows API imports detected, including network functions from ws2_32.dll"
                },
                {
                    command: "strings malware.exe | grep -i 'http'",
                    output: `http://c2-malware-domain[.]com/beacon
http://c2-malware-domain[.]com/download/payload.bin
http://c2-malware-domain[.]com/upload/data
User-Agent: MalwareBot/1.0`,
                    analysis: "C2 server URLs found with specific User-Agent string"
                },
                {
                    command: "strings malware.exe | grep -i 'flag'",
                    output: `# Flag format: FLAG{STRING_ANALYSIS_COMPLETE}
# Look for C2 domain in strings output
# C2 domain: c2-malware-domain[.]com`,
                    analysis: "Found flag hint and C2 domain confirmation"
                }
            ],
            flag: "FLAG{STRING_ANALYSIS_COMPLETE}",
            hint: "Extract readable strings and look for URLs using the 'strings' command. Search for 'http' patterns.",
            tools: ["strings", "rabin2 -z", "FLOSS", "BinText"],
            points: 75,
            analyzed: false,
            captured: false
        },
        3: {
            id: 3,
            name: "Hashing & Signatures",
            description: "Calculate malware hash and identify variants",
            clues: [
                {
                    command: "md5sum malware.exe",
                    output: "d41d8cd98f00b204e9800998ecf8427e  malware.exe",
                    analysis: "MD5 hash calculated"
                },
                {
                    command: "sha256sum malware.exe",
                    output: "9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08  malware.exe",
                    analysis: "SHA256 hash calculated - use this for malware identification"
                },
                {
                    command: "ssdeep malware.exe",
                    output: `49152:ABCD1234...:malware_sample
Match found: 95% similarity with known malware family "RedlineStealer"`,
                    analysis: "Fuzzy hash indicates high similarity with RedlineStealer malware family"
                },
                {
                    command: "echo 'Check hash databases for IOCs'",
                    output: `# VirusTotal Search: 9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08
# MalwareBazaar: Search this hash for related samples
# Flag: FLAG{SHA256_HASH_IDENTIFIED}`,
                    analysis: "Use the SHA256 hash to search threat intelligence platforms"
                }
            ],
            flag: "FLAG{SHA256_HASH_IDENTIFIED}",
            hint: "Calculate the SHA256 hash to identify the malware sample. Look at the hash output carefully.",
            tools: ["md5sum", "sha256sum", "ssdeep", "VirusTotal API"],
            points: 100,
            analyzed: false,
            captured: false
        },
        4: {
            id: 4,
            name: "Network Analysis",
            description: "Analyze C2 communication and beaconing",
            clues: [
                {
                    command: "tcpdump -r traffic.pcap -c 5",
                    output: `reading from file traffic.pcap, link-type EN10MB (Ethernet)
03:47:22.123456 IP 192.168.1.100.49152 > 185.216.34.21.443: Flags [S], seq 1234567890, win 64240, options [mss 1460], length 0
03:47:22.234567 IP 185.216.34.21.443 > 192.168.1.100.49152: Flags [S.], seq 987654321, ack 1234567891, win 29200, options [mss 1460], length 0
03:47:22.345678 IP 192.168.1.100.49152 > 185.216.34.21.443: Flags [.], ack 1, win 64240, length 0`,
                    analysis: "Initial TCP handshake with suspicious IP 185.216.34.21 on port 443"
                },
                {
                    command: "tcpdump -r traffic.pcap 'port 443' -A | head -10",
                    output: `03:52:18.456789 IP 192.168.1.100.49152 > 185.216.34.21.443: Flags [P.], seq 1:100, ack 1, win 8192, length 99
E..E..@.@...........9.i5......4...d...Y........POST /beacon HTTP/1.1
Host: c2-malware-domain[.]com
User-Agent: MalwareBot/1.0
Content-Type: application/json

{"status":"active","id":"m4lw4r3_1d"}`,
                    analysis: "HTTP POST beaconing detected to C2 server with malware identifier"
                },
                {
                    command: "echo 'Analyze beaconing interval'",
                    output: `# Beaconing detected every 300 seconds (5 minutes)
# Data exfiltration to same IP
# Flag clue: C2 traffic uses standard HTTPS port
# Final flag: FLAG{C2_TRAFFIC_ANALYZED}`,
                    analysis: "Regular beaconing pattern identified"
                }
            ],
            flag: "FLAG{C2_TRAFFIC_ANALYZED}",
            hint: "Analyze network traffic for connections to suspicious IP addresses. Look for regular patterns.",
            tools: ["Wireshark", "tcpdump", "NetworkMiner", "Zeek"],
            points: 150,
            analyzed: false,
            captured: false
        },
        5: {
            id: 5,
            name: "Reverse Engineering",
            description: "Decompile and analyze hidden payload",
            clues: [
                {
                    command: "rabin2 -I malware.exe",
                    output: `arch     x86
binsz    2457600
bintype  pe
class    PE32
lang     c
machine  i386
os       windows
subsys   Windows GUI
stripped false
static   false
linenum  false
lsyms    false
relocs   true`,
                    analysis: "32-bit x86 PE executable, not stripped (symbols available)"
                },
                {
                    command: "rabin2 -zz malware.exe | grep -i 'flag'",
                    output: `# Hidden string found: "FLAG_HINT: Look at function names"
# Decoded: CheckWinMain function contains interesting code`,
                    analysis: "Flag hint found in strings"
                },
                {
                    command: "r2 -A malware.exe",
                    output: `[0x00401000]> pd 20 @ main
0x00401000    55           push ebp
0x00401001    89e5         mov ebp, esp
0x00401003    81ec00010000 sub esp, 0x100
0x00401009    68d0204000   push str.Backdoor_activated ; 0x4020d0
0x0040100e    e8fd0f0000   call sym.imp.system
0x00401013    83c404       add esp, 4
0x00401016    68e0204000   push str.FLAG_REVERSED_PAYLOAD ; 0x4020e0
0x0040101b    e8f00f0000   call sym.imp.printf`,
                    analysis: "Backdoor activation routine found, flag string pushed to stack"
                },
                {
                    command: "echo 'Decompile main function'",
                    output: `int main() {
    printf("Backdoor activated\\n");
    printf("Payload decrypted: FLAG{REVERSED_PAYLOAD}\\n");
    initiate_c2_connection();
    return 0;
}`,
                    analysis: "Main function reveals the flag in printf statement"
                }
            ],
            flag: "FLAG{REVERSED_PAYLOAD}",
            hint: "Disassemble the binary to find hidden functions and payload. Look at the main function.",
            tools: ["radare2", "Ghidra", "IDA Pro", "x64dbg"],
            points: 200,
            analyzed: false,
            captured: false
        }
    },
    
    state: {
        currentAnalysis: null,
        capturedFlags: 0,
        totalPoints: 0,
        startTime: Date.now(),
        terminalHistory: []
    }
};

// DOM Elements
const terminalOutput = document.getElementById('terminal-output');
const terminalInput = document.getElementById('terminal-input');
const progressBar = document.getElementById('progress-bar');
const progressPercent = document.getElementById('progress-percent');
const totalPoints = document.getElementById('total-points');
const flagsCaptured = document.getElementById('flags-captured');
const timeSpent = document.getElementById('time-spent');

// Initialize the CTF
function initCTF() {
    // Start the timer
    updateTimer();
    setInterval(updateTimer, 1000);
    
    // Initialize terminal input
    terminalInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            processCommand(this.value);
            this.value = '';
        }
    });
    
    // Add some initial terminal output
    addTerminalLine("Malware Analysis CTF v2.0 initialized");
    addTerminalLine("=======================================");
    addTerminalLine("Click START ANALYSIS on any flag to begin investigation");
    addTerminalLine("Analyze clues in terminal ‚Üí Extract flag ‚Üí Submit in flag card");
    addTerminalLine("Type 'help' for available commands");
    addTerminalLine("");
}

// Update the timer display
function updateTimer() {
    const elapsed = Math.floor((Date.now() - ctfData.state.startTime) / 1000);
    const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
    const seconds = (elapsed % 60).toString().padStart(2, '0');
    timeSpent.textContent = `${minutes}:${seconds}`;
}

// Start analysis for a flag
function startAnalysis(flagId) {
    const flag = ctfData.flags[flagId];
    
    if (flag.analyzed) {
        addTerminalLine(`Flag ${flagId} analysis already completed. Submit flag above.`);
        return;
    }
    
    ctfData.state.currentAnalysis = flagId;
    flag.analyzed = true;
    
    // Show the flag submit input
    document.getElementById(`flag${flagId}-submit`).style.display = 'block';
    
    // Clear terminal and start analysis
    clearTerminal();
    addTerminalLine(`Starting analysis for Flag ${flagId}: ${flag.name}`);
    addTerminalLine("=".repeat(50));
    addTerminalLine("");
    
    // Show analysis steps with delay
    let delay = 1000;
    flag.clues.forEach((clue, index) => {
        setTimeout(() => {
            showAnalysisStep(flagId, index);
        }, delay);
        delay += 2000;
    });
    
    // Show final clue
    setTimeout(() => {
        showFinalClue(flagId);
    }, delay + 1000);
}

// Show analysis step
function showAnalysisStep(flagId, stepIndex) {
    const flag = ctfData.flags[flagId];
    const clue = flag.clues[stepIndex];
    
    const stepDiv = document.createElement('div');
    stepDiv.className = 'analysis-step';
    stepDiv.innerHTML = `
        <div class="step-title">
            <i class="bi bi-terminal"></i>
            Step ${stepIndex + 1}: ${clue.command}
        </div>
        <div class="step-content">
            <div class="terminal-command">$ ${clue.command}</div>
            <div class="terminal-output">
                ${clue.output.split('\n').map(line => `<div class="output-line">${line}</div>`).join('')}
            </div>
            <div class="analysis-text">
                <strong>Analysis:</strong> ${clue.analysis}
            </div>
        </div>
    `;
    
    terminalOutput.appendChild(stepDiv);
    terminalOutput.scrollTop = terminalOutput.scrollHeight;
}

// Show final clue with flag hint
function showFinalClue(flagId) {
    const flag = ctfData.flags[flagId];
    
    const clueDiv = document.createElement('div');
    clueDiv.className = 'flag-clue';
    clueDiv.innerHTML = `
        <div class="clue-title">
            <i class="bi bi-search"></i>
            FLAG CLUE
        </div>
        <div class="clue-text">
            <p>Based on your analysis, extract the flag from the clues above.</p>
            <p><strong>Flag format:</strong> FLAG{...}</p>
            <p class="clue-hint">Hint: ${flag.hint}</p>
        </div>
        <div class="tools-list">
            <strong>Suggested Tools:</strong>
            ${flag.tools.map(tool => `<span class="tool-tag">${tool}</span>`).join('')}
        </div>
    `;
    
    terminalOutput.appendChild(clueDiv);
    
    // Add instructions
    const instructionDiv = document.createElement('div');
    instructionDiv.className = 'success-message';
    instructionDiv.innerHTML = `
        <strong><i class="bi bi-info-circle"></i> Instructions:</strong>
        <p>1. Review the analysis output above</p>
        <p>2. Extract the flag from the clues</p>
        <p>3. Enter the flag in the input box above (Flag ${flagId} card)</p>
        <p>4. Click submit to verify</p>
    `;
    
    terminalOutput.appendChild(instructionDiv);
    terminalOutput.scrollTop = terminalOutput.scrollHeight;
}

// Submit flag for verification
function submitFlag(flagId) {
    const flagInput = document.getElementById(`flag${flagId}-input`);
    const userFlag = flagInput.value.trim();
    const flag = ctfData.flags[flagId];
    
    if (!userFlag) {
        showError("Please enter a flag");
        return;
    }
    
    if (userFlag.toUpperCase() === flag.flag.toUpperCase()) {
        captureFlag(flagId);
    } else {
        showError("Incorrect flag! Review the analysis clues carefully.");
    }
}

// Capture a flag
function captureFlag(flagId) {
    const flag = ctfData.flags[flagId];
    const flagElement = document.querySelector(`.flag-card[data-flag="${flagId}"]`);
    const statusElement = document.getElementById(`flag${flagId}-status`);
    
    // Update state
    flag.captured = true;
    ctfData.state.capturedFlags++;
    ctfData.state.totalPoints += flag.points;
    
    // Update UI
    flagElement.classList.add('captured');
    statusElement.textContent = "CAPTURED";
    statusElement.style.background = "rgba(0, 255, 136, 0.2)";
    statusElement.style.color = "var(--success)";
    statusElement.style.borderColor = "rgba(0, 255, 136, 0.3)";
    
    // Hide submit input
    document.getElementById(`flag${flagId}-submit`).style.display = 'none';
    
    // Update progress
    updateProgress();
    
    // Show success message
    showSuccess(flagId);
    
    // Check if all flags captured
    if (ctfData.state.capturedFlags === 5) {
        setTimeout(() => {
            triggerVictory();
        }, 2000);
    }
}

// Show success modal
function showSuccess(flagId) {
    const flag = ctfData.flags[flagId];
    const modal = new bootstrap.Modal(document.getElementById('successModal'));
    const content = document.getElementById('successContent');
    
    content.innerHTML = `
        <div class="text-center">
            <div class="mb-3">
                <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
            </div>
            <h4 class="text-success mb-3">FLAG CAPTURED!</h4>
            <p>Flag ${flagId}: ${flag.name}</p>
            <p class="mb-3"><strong>${flag.points}</strong> points earned</p>
            <div class="flag-display p-3 bg-dark rounded">
                <code class="text-success">${flag.flag}</code>
            </div>
            <p class="mt-3 text-muted">Flag added to your collection</p>
        </div>
    `;
    
    modal.show();
    
    // Add terminal message
    addTerminalLine("");
    addTerminalLine(`‚úì Flag ${flagId} captured: ${flag.flag}`);
    addTerminalLine(`+${flag.points} points added to your score`);
}

// Show error modal
function showError(message) {
    const modal = new bootstrap.Modal(document.getElementById('errorModal'));
    const content = document.getElementById('errorContent');
    
    content.innerHTML = `
        <div class="text-center">
            <div class="mb-3">
                <i class="bi bi-x-circle-fill text-danger" style="font-size: 3rem;"></i>
            </div>
            <h4 class="text-danger mb-3">INCORRECT FLAG</h4>
            <p>${message}</p>
            <div class="mt-4">
                <button class="btn btn-cyber" data-bs-dismiss="modal">
                    <i class="bi bi-arrow-left"></i> Try Again
                </button>
            </div>
        </div>
    `;
    
    modal.show();
}

// Update progress bar and stats
function updateProgress() {
    const progress = Math.floor((ctfData.state.capturedFlags / 5) * 100);
    
    // Animate progress bar
    progressBar.style.width = `${progress}%`;
    progressPercent.textContent = `${progress}%`;
    totalPoints.textContent = ctfData.state.totalPoints;
    flagsCaptured.textContent = `${ctfData.state.capturedFlags}/5`;
    
    // Add points animation
    const pointsElement = totalPoints;
    pointsElement.style.transform = 'scale(1.2)';
    pointsElement.style.color = 'var(--success)';
    setTimeout(() => {
        pointsElement.style.transform = 'scale(1)';
        pointsElement.style.color = 'var(--cyber-blue)';
    }, 300);
}

// Show hint for a flag
function showHint(flagId) {
    const flag = ctfData.flags[flagId];
    const hintModal = new bootstrap.Modal(document.getElementById('hintModal'));
    const hintContent = document.getElementById('hintContent');
    
    hintContent.innerHTML = `
        <div class="hint-header mb-3">
            <h6 class="text-warning"><i class="bi bi-flag"></i> Flag ${flagId}: ${flag.name}</h6>
        </div>
        <div class="hint-body">
            <p>${flag.hint}</p>
            <div class="tools-list mt-3">
                <strong>Suggested Tools:</strong>
                <div class="d-flex flex-wrap gap-2 mt-2">
                    ${flag.tools.map(tool => `<span class="tool-tag">${tool}</span>`).join('')}
                </div>
            </div>
            ${flag.analyzed ? `
            <div class="alert alert-info mt-3">
                <i class="bi bi-info-circle"></i> Analysis already started. Check terminal for clues.
            </div>
            ` : ''}
        </div>
        <div class="mt-4">
            <button class="btn btn-cyber w-100" onclick="startAnalysis(${flagId})" data-bs-dismiss="modal">
                <i class="bi bi-play-circle"></i> Start Analysis
            </button>
        </div>
    `;
    
    hintModal.show();
}

// Process terminal commands
function processCommand(cmd) {
    cmd = cmd.trim().toLowerCase();
    addTerminalLine(`root@forensics:~$ ${cmd}`);
    
    if (cmd.startsWith('analyze')) {
        const flagNum = parseInt(cmd.split(' ')[1]);
        if (flagNum >= 1 && flagNum <= 5) {
            startAnalysis(flagNum);
        } else {
            addTerminalLine(`Invalid flag number: ${flagNum}. Use 1-5`);
        }
    } else if (cmd === 'help') {
        showHelp();
    } else if (cmd === 'status') {
        showStatus();
    } else if (cmd === 'clear') {
        clearTerminal();
    } else if (cmd === 'flags') {
        showFlags();
    } else if (cmd.startsWith('hint')) {
        const flagNum = parseInt(cmd.split(' ')[1]);
        if (flagNum >= 1 && flagNum <= 5) {
            showHint(flagNum);
        }
    } else if (cmd === 'reset') {
        resetCTF();
    } else {
        addTerminalLine(`Command not found: ${cmd}. Type 'help' for available commands`);
    }
}

// Show help in terminal
function showHelp() {
    addTerminalLine("Available commands:");
    addTerminalLine("  analyze [1-5]     - Start analysis for a specific flag");
    addTerminalLine("  status            - Show CTF progress");
    addTerminalLine("  flags             - List all flags");
    addTerminalLine("  hint [1-5]        - Get hint for a flag");
    addTerminalLine("  clear             - Clear terminal");
    addTerminalLine("  reset             - Reset entire CTF");
    addTerminalLine("  help              - Show this help");
    addTerminalLine("");
    addTerminalLine("Or click START ANALYSIS buttons on flag cards");
}

// Show status in terminal
function showStatus() {
    addTerminalLine("CTF Status:");
    addTerminalLine(`  Flags captured: ${ctfData.state.capturedFlags}/5`);
    addTerminalLine(`  Total points: ${ctfData.state.totalPoints}`);
    const progress = Math.floor((ctfData.state.capturedFlags / 5) * 100);
    addTerminalLine(`  Progress: ${progress}%`);
    addTerminalLine("");
    addTerminalLine("Flag Status:");
    for (let i = 1; i <= 5; i++) {
        const flag = ctfData.flags[i];
        const status = flag.captured ? "CAPTURED" : flag.analyzed ? "ANALYZED" : "LOCKED";
        addTerminalLine(`  Flag ${i}: ${status} (${flag.points} pts)`);
    }
}

// Show all flags in terminal
function showFlags() {
    addTerminalLine("Flag List:");
    for (let i = 1; i <= 5; i++) {
        const flag = ctfData.flags[i];
        const status = flag.captured ? "‚úÖ CAPTURED" : flag.analyzed ? "üîç ANALYZED" : "üîí LOCKED";
        addTerminalLine(`  ${i}. ${flag.name} - ${status}`);
        addTerminalLine(`     ${flag.description}`);
        addTerminalLine(`     Points: ${flag.points}`);
        addTerminalLine("");
    }
}

// Add line to terminal with animation
function addTerminalLine(text, className = '') {
    const line = document.createElement('div');
    line.className = `terminal-line ${className}`;
    
    if (text.startsWith('root@')) {
        line.innerHTML = text;
    } else if (text.startsWith('‚úì') || text.startsWith('+')) {
        line.innerHTML = `<span class="text-success">${text}</span>`;
    } else {
        line.innerHTML = `<span class="prompt">root@forensics:~$</span> ${text}`;
    }
    
    terminalOutput.appendChild(line);
    terminalOutput.scrollTop = terminalOutput.scrollHeight;
}

// Clear terminal
function clearTerminal() {
    terminalOutput.innerHTML = '';
    addTerminalLine('Terminal cleared');
    addTerminalLine('Type commands or click START ANALYSIS buttons');
}

// Close terminal (minimize)
function closeTerminal() {
    const terminal = document.querySelector('.terminal-panel');
    terminal.style.transform = 'translateY(100%)';
    terminal.style.opacity = '0';
    
    setTimeout(() => {
        terminal.style.display = 'none';
        // Create reopen button
        const reopenBtn = document.createElement('button');
        reopenBtn.className = 'btn btn-cyber reopen-terminal';
        reopenBtn.innerHTML = '<i class="bi bi-terminal"></i> OPEN TERMINAL';
        reopenBtn.style.position = 'fixed';
        reopenBtn.style.bottom = '20px';
        reopenBtn.style.right = '20px';
        reopenBtn.style.zIndex = '1000';
        reopenBtn.onclick = reopenTerminal;
        document.body.appendChild(reopenBtn);
    }, 400);
}

// Reopen terminal
function reopenTerminal() {
    const terminal = document.querySelector('.terminal-panel');
    const reopenBtn = document.querySelector('.reopen-terminal');
    
    if (reopenBtn) reopenBtn.remove();
    
    terminal.style.display = 'block';
    setTimeout(() => {
        terminal.style.transform = 'translateY(0)';
        terminal.style.opacity = '1';
    }, 10);
}

// Trigger victory celebration
function triggerVictory() {
    // Clear terminal for victory message
    clearTerminal();
    
    // Add victory message with typing effect
    setTimeout(() => {
        addTerminalLine("");
        addTerminalLine("üéâ CONGRATULATIONS! üéâ");
        addTerminalLine("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
        addTerminalLine("");
        addTerminalLine("You have successfully completed the Malware Analysis CTF!");
        addTerminalLine("");
        addTerminalLine("All 5 flags captured ‚úì");
        addTerminalLine(`Total Score: ${ctfData.state.totalPoints} points`);
        addTerminalLine("");
        addTerminalLine("Skills demonstrated:");
        addTerminalLine("‚úì File type identification");
        addTerminalLine("‚úì Strings analysis");
        addTerminalLine("‚úì Hash calculation");
        addTerminalLine("‚úì Network traffic analysis");
        addTerminalLine("‚úì Reverse engineering");
        addTerminalLine("");
        addTerminalLine("Mission accomplished!");
        addTerminalLine("");
        
        // Show victory modal
        const victoryModal = new bootstrap.Modal(document.getElementById('successModal'));
        const content = document.getElementById('successContent');
        
        content.innerHTML = `
            <div class="text-center">
                <div class="mb-3">
                    <i class="bi bi-trophy-fill text-warning" style="font-size: 4rem;"></i>
                </div>
                <h2 class="text-success mb-3">MISSION COMPLETE!</h2>
                <p class="mb-4">All malware analysis flags captured successfully!</p>
                
                <div class="victory-stats p-4 bg-dark rounded mb-4">
                    <div class="row">
                        <div class="col-6 mb-3">
                            <h3 class="text-warning">${ctfData.state.totalPoints}</h3>
                            <small>TOTAL POINTS</small>
                        </div>
                        <div class="col-6 mb-3">
                            <h3 class="text-success">5/5</h3>
                            <small>FLAGS CAPTURED</small>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <h4 class="text-info">SECURITY ANALYST</h4>
                            <small>LEVEL ACHIEVED</small>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <button class="btn btn-cyber" onclick="resetCTF()" data-bs-dismiss="modal">
                        <i class="bi bi-arrow-clockwise"></i> RESTART MISSION
                    </button>
                </div>
                
                <small class="text-muted">Share your score with #MalwareAnalysisCTF</small>
            </div>
        `;
        
        victoryModal.show();
        
        // Create confetti
        createConfetti();
    }, 500);
}

// Create confetti effect
function createConfetti() {
    const colors = ['#00ff41', '#00b4ff', '#9d00ff', '#ff003c', '#ffcc00'];
    
    for (let i = 0; i < 100; i++) {
        setTimeout(() => {
            const confetti = document.createElement('div');
            const color = colors[Math.floor(Math.random() * colors.length)];
            
            confetti.style.cssText = `
                position: fixed;
                width: ${Math.random() * 10 + 5}px;
                height: ${Math.random() * 10 + 5}px;
                background: ${color};
                border-radius: ${Math.random() > 0.5 ? '50%' : '2px'};
                top: -20px;
                left: ${Math.random() * 100}vw;
                opacity: 0.9;
                z-index: 9999;
            `;
            
            document.body.appendChild(confetti);
            
            const animation = confetti.animate([
                { 
                    transform: `translateY(0) rotate(0deg)`, 
                    opacity: 1 
                },
                { 
                    transform: `translateY(${window.innerHeight}px) rotate(${Math.random() * 720}deg)`, 
                    opacity: 0 
                }
            ], {
                duration: Math.random() * 3000 + 2000,
                easing: 'cubic-bezier(0.215, 0.61, 0.355, 1)'
            });
            
            animation.onfinish = () => confetti.remove();
        }, i * 30);
    }
}

// Reset the CTF
function resetCTF() {
    // Close all modals
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        bootstrap.Modal.getInstance(modal)?.hide();
    });
    
    // Reset game state
    ctfData.state.capturedFlags = 0;
    ctfData.state.totalPoints = 0;
    ctfData.state.startTime = Date.now();
    ctfData.state.currentAnalysis = null;
    
    // Reset flags
    for (let i = 1; i <= 5; i++) {
        ctfData.flags[i].analyzed = false;
        ctfData.flags[i].captured = false;
        
        // Reset UI
        const flagElement = document.querySelector(`.flag-card[data-flag="${i}"]`);
        const statusElement = document.getElementById(`flag${i}-status`);
        const submitElement = document.getElementById(`flag${i}-submit`);
        
        flagElement.classList.remove('captured');
        statusElement.textContent = "LOCKED";
        statusElement.style.background = "rgba(255, 0, 60, 0.2)";
        statusElement.style.color = "var(--danger)";
        statusElement.style.borderColor = "rgba(255, 0, 60, 0.3)";
        
        submitElement.style.display = 'none';
        document.getElementById(`flag${i}-input`).value = '';
    }
    
    // Reset progress
    updateProgress();
    
    // Clear terminal
    clearTerminal();
    addTerminalLine("CTF reset. Starting new mission...");
    addTerminalLine("Click START ANALYSIS on any flag to begin");
    addTerminalLine("");
    
    // Reopen terminal if minimized
    reopenTerminal();
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', initCTF);